<!DOCTYPE html>
<html>
<head>
    <title>手术排台系统</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f2f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            width: 100%;
            margin: 20px 0;
        }
        .surgery-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .surgery-table th, .surgery-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .surgery-table th {
            background-color: #f5f5f5;
        }
        .button-group {
            margin: 20px 0;
            text-align: center;
        }
        .button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #4a90e2;
            color: white;
        }
        .button:hover {
            background-color: #357abd;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            position: relative;
        }
        .close {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
        }
        .form-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
        }
        .form-group label {
            width: 120px;
            text-align: right;
            margin-right: 15px;
        }
        .form-group input, .form-group select {
            width: 250px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        @media print {
            .no-print {
                display: none;
            }
            .surgery-table {
                font-size: 12pt;
            }
        }

        @media print {
    @page {
        size: landscape;
        margin: 1cm;
    }

    /* Hide all elements initially */
    body * {
        display: none;
    }

    /* Show only what we want to print */
    .print-content,
    .print-content *,
    .surgery-table,
    .surgery-table *,
    .title,
    h1,
    .summary {
        display: block !important;
    }

    /* Table cells should be table-cell */
    .surgery-table td,
    .surgery-table th {
        display: table-cell !important;
    }

    /* Table rows should be table-row */
    .surgery-table tr {
        display: table-row !important;
    }

    /* Table sections should be table-row-group */
    .surgery-table thead,
    .surgery-table tbody,
    .surgery-table tfoot {
        display: table-row-group !important;
    }

    /* The table itself should be table */
    .surgery-table {
        display: table !important;
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    /* Style the title */
    h1 {
        text-align: center;
        font-size: 18pt;
        font-weight: bold;
        margin-bottom: 20px;
    }

    /* Style the summary */
    .summary {
        text-align: left;
        font-size: 10pt;
        margin: 20px 0;
    }

    /* Style table cells */
    .surgery-table th,
    .surgery-table td {
        border: 1px solid black;
        padding: 4px;
        text-align: center;
        font-size: 10pt;
    }

    /* Hide specific elements */
    .no-print,
    .button-group,
    .header,
    .department-selection,
    .date-navigation,
    .modal {
        display: none !important;
    }
}

/* Add or update these styles in the style section */
.form-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* Creates 3 columns */
    gap: 15px;
    padding: 20px;
}

.form-group {
    margin: 5px 0;
    display: flex;
    align-items: center;
}

.form-group label {
    width: 80px;
    text-align: right;
    margin-right: 10px;
    flex-shrink: 0;
}

.form-group input,
.form-group select {
    flex: 1;
    padding: 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: calc(100% - 90px); /* Adjust input width */
}

.button-group {
    grid-column: 1 / -1; /* Span all columns */
    text-align: center;
    margin-top: 20px;
}

.modal-content {
    width: 90%;
    max-width: 1000px; /* Increased max-width to accommodate horizontal layout */
}

/* Add this to the existing print styles in the <style> section */
<style>
    @media print {
        /* Hide edit/delete buttons when printing */
        .no-print,
        .edit-btn,
        .delete-btn {
            display: none !important;
        }
        
        /* Hide the operations column entirely when printing */
        .surgery-table td:last-child,
        .surgery-table th:last-child {
            display: none !important;
        }

        /* Hide the operations column and buttons when printing */
        .operations-column {
            display: none !important;
        }
        
        .edit-btn, 
        .delete-btn {
            display: none !important;
        }
    }
</style>
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>手术排台系统</h1>
            <div>
                <button class="button" onclick="window.location.href='/db/maintenance'">数据库维护</button>
                <button class="button" onclick="logout()">退出登录</button>
            </div>
        </div>

        <div class="department-selection" id="departmentSelection">
            <h2>选择科室</h2>
            <div class="button-group">
                <button class="button" onclick="selectDepartment('一病区')">一病区</button>
                <button class="button" onclick="selectDepartment('二病区')">二病区</button>
                <button class="button" onclick="selectDepartment('手术麻醉科')">手术麻醉科</button>
            </div>
        </div>

        <div id="viewModeSelection" style="display: none;">
            <h2>请选择查看方式</h2>
            <div class="button-group">
                <button class="button" onclick="selectViewMode('combined')">合并显示</button>
                <button class="button" onclick="selectViewMode('separate')">分开显示</button>
            </div>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="date-navigation">
                <button onclick="changeDate('prev')">&lt; 前一天</button>
                <input type="date" id="dateSelector" onchange="selectDate(this.value)">
                <button onclick="changeDate('next')">后一天 &gt;</button>
            </div>

            <!-- Combined View -->
            <div id="combinedTable" style="display: none;">
                <div class="title" id="tableTitle">
                    <!-- This will be populated dynamically -->
                </div>
                <div class="button-group">
                    <button class="button" onclick="showHistoryModal()">历史记录</button>
                    <button class="button" onclick="exportAnesthesiaData()">数据</button>
                    <button class="button" onclick="printCombinedTable()">打印合并表</button>
                </div>
                <table class="surgery-table">
                    <thead>
                        <tr>
                            <th>床号</th>
                            <th>姓名</th>
                            <th>性别</th>
                            <th>年龄</th>
                            <th>住院号</th>
                            <th>临床诊断</th>
                            <th>术式</th>
                            <th>主刀</th>
                            <th>助手</th>
                            <th>管床医师</th>
                            <th>麻醉</th>
                            <th>术前准备</th>
                            <th>台次</th>
                            <th>科室</th>
                        </tr>
                    </thead>
                    <tbody id="surgeryTableBody"></tbody>
                    <tfoot id="surgeryTableSummary"></tfoot>
                </table>
            </div>

            <!-- Separate View -->
            <div id="separateView" style="display: none;">
                <div class="button-group">
                    <button class="button" onclick="showHistoryModal()">历史记录</button>
                    <button class="button" onclick="exportAnesthesiaData()">导出数据</button>
                </div>
                <div class="ward-section">
                    <div class="title" id="ward1Title">一病区手术安排表</div>
                    <button class="button" onclick="printTable('ward1')">打印一病区</button>
                    <table id="ward1Table" class="surgery-table">
                        <thead>
                            <tr>
                                <th>床号</th>
                                <th>姓名</th>
                                <th>性别</th>
                                <th>年龄</th>
                                <th>住院号</th>
                                <th>临床诊断</th>
                                <th>术式</th>
                                <th>主刀</th>
                                <th>助手</th>
                                <th>管床医师</th>
                                <th>麻醉</th>
                                <th>术前准备</th>
                                <th>台次</th>
                            </tr>
                        </thead>
                        <tbody id="ward1TableBody"></tbody>
                        <tfoot id="ward1TableSummary"></tfoot>
                    </table>
                </div>

                <div class="ward-section">
                    <div class="title" id="ward2Title">二病区手术安排表</div>
                    <button class="button" onclick="printTable('ward2')">打印二病区</button>
                    <table id="ward2Table" class="surgery-table">
                        <thead>
                            <tr>
                                <th>床号</th>
                                <th>姓名</th>
                                <th>性别</th>
                                <th>年龄</th>
                                <th>住院号</th>
                                <th>临床诊断</th>
                                <th>术式</th>
                                <th>主刀</th>
                                <th>助手</th>
                                <th>管床医师</th>
                                <th>麻醉</th>
                                <th>术前准备</th>
                                <th>台次</th>
                            </tr>
                        </thead>
                        <tbody id="ward2TableBody"></tbody>
                        <tfoot id="ward2TableSummary"></tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add/Edit Surgery Modal -->
        <div id="surgeryModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeSurgeryModal()">&times;</span>
                <h3 id="modalTitle">添加手术安排</h3>
                <form id="surgeryForm">
                    <div class="form-container">
                        <div class="form-group">
                            <label>日期：</label>
                            <input type="date" id="surgeryDate" required>
                        </div>
                        <div class="form-group">
                            <label>床号：</label>
                            <input type="text" id="bedNumber" required>
                        </div>
                        <div class="form-group">
                            <label>姓名：</label>
                            <input type="text" id="patientName" required>
                        </div>
                        <div class="form-group">
                            <label>性别：</label>
                            <select id="gender" required>
                                <option value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>年龄：</label>
                            <input type="number" id="age" required>
                        </div>
                        <div class="form-group">
                            <label>住院号：</label>
                            <input type="text" id="hospitalNumber" required>
                        </div>
                        <div class="form-group">
                            <label>床诊断：</label>
                            <input type="text" id="diagnosis" required>
                        </div>
                        <div class="form-group">
                            <label>术式：</label>
                            <input type="text" id="operation" required>
                        </div>
                        <div class="form-group">
                            <label>主刀：</label>
                            <input type="text" id="mainSurgeon" required>
                        </div>
                        <div class="form-group">
                            <label>助手：</label>
                            <input type="text" id="assistant" required>
                        </div>
                        <div class="form-group">
                            <label>管床医师：</label>
                            <input type="text" id="wardDoctor" required>
                        </div>
                        <div class="form-group">
                            <label>麻醉：</label>
                            <select id="anesthesia" required>
                                <option value="全麻">全麻</option>
                                <option value="局麻">局麻</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>术前准备：</label>
                            <select id="preOpPrep">
                                <option value="无">无</option>
                                <option value="有">有</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>台次：</label>
                            <input type="number" id="operationOrder" required>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>从HTML导入：</label>
                            <input type="file" id="htmlFile" accept=".html" onchange="parseHtmlFile(this)">
                        </div>
                        <div class="button-group">
                            <button type="submit" class="button">保存</button>
                            <button type="button" class="button" onclick="closeSurgeryModal()">取消</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- History Modal -->
        <div id="historyModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeHistoryModal()">&times;</span>
                <h3>历记录查询</h3>
                <div class="form-group">
                    <label>开始日期：</label>
                    <input type="date" id="historyStartDate">
                </div>
                <div class="form-group">
                    <label>束日期：</label>
                    <input type="date" id="historyEndDate">
                </div>
                <button class="button" onclick="searchHistory()">查询</button>
                <div id="historyResults" style="margin-top: 20px; max-height: 500px; overflow-y: auto;">
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let currentDepartment = null;
        let editingId = null;

        // Initialize the page
        window.onload = function() {
            if (!localStorage.getItem('surgery_auth')) {
                window.location.href = '/';
                return;
            }
            
            // Initialize date selector
            document.getElementById('dateSelector').value = currentDate.toISOString().split('T')[0];
            
            // Check if there's a saved department
            const savedDepartment = localStorage.getItem('selected_department');
            if (savedDepartment) {
                // Restore the previous department view
                currentDepartment = savedDepartment;
                document.getElementById('departmentSelection').style.display = 'none';
                
                if (savedDepartment === '手术麻醉科') {
                    // Show view mode selection for anesthesia department
                    document.getElementById('viewModeSelection').style.display = 'block';
                } else {
                    // For individual departments
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('combinedTable').style.display = 'block';
                    document.getElementById('separateView').style.display = 'none';
                    
                    // Add the "Add Surgery" button for individual departments
                    const buttonGroup = document.querySelector('#combinedTable .button-group');
                    buttonGroup.innerHTML = `
                        <button class="button" onclick="showAddSurgery()">排手术</button>
                        <button class="button" onclick="showHistoryModal()">历史记录</button>
                        <button class="button" onclick="exportData()">导出数据</button>
                        <button class="button" onclick="printDepartmentTable()">打印</button>
                    `;
                    
                    // Update table header without department column
                    updateTableHeader(false);
                    loadSurgeries();
                }
            } else {
                // Show department selection if no department is saved
                document.getElementById('departmentSelection').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('viewModeSelection').style.display = 'none';
            }
        };

        function selectDepartment(department) {
            currentDepartment = department;
            // Save the selected department
            localStorage.setItem('selected_department', department);
            
            document.getElementById('departmentSelection').style.display = 'none';
            
            if (department === '手术麻醉科') {
                // Show view mode selection
                document.getElementById('viewModeSelection').style.display = 'block';
            } else {
                // For individual departments
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('combinedTable').style.display = 'block';
                document.getElementById('separateView').style.display = 'none';
                
                // Add the "Add Surgery" button for individual departments
                const buttonGroup = document.querySelector('#combinedTable .button-group');
                buttonGroup.innerHTML = `
                    <button class="button" onclick="showAddSurgery()">排手术</button>
                    <button class="button" onclick="showHistoryModal()">历史记录</button>
                    <button class="button" onclick="exportData()">导出数据</button>
                    <button class="button" onclick="printDepartmentTable()">打印</button>
                `;
                
                // Update table header without department column
                updateTableHeader(false);
                loadSurgeries();
            }
        }

        function loadSurgeries() {
            const dateStr = currentDate.toISOString().split('T')[0];
            
            if (currentDepartment === '手术麻醉科') {
                // Fetch surgeries from both departments
                Promise.all([
                    fetch(`/api/surgeries?date=${dateStr}&department=${encodeURIComponent('一病区')}`).then(r => r.json()),
                    fetch(`/api/surgeries?date=${dateStr}&department=${encodeURIComponent('二病区')}`).then(r => r.json())
                ])
                .then(([data1, data2]) => {
                    if (data1.success && data2.success) {
                        const allSurgeries = [
                            ...data1.surgeries.map(s => ({...s, Department: '一病区'})),
                            ...data2.surgeries.map(s => ({...s, Department: '二病区'}))
                        ].sort((a, b) => a.OperationOrder - b.OperationOrder);
                        
                        // Update the table title for anesthesia department
                        document.getElementById('tableTitle').textContent = 
                            `颌面外科手术安排表 ${dateStr}`;
                        
                        displaySurgeries(allSurgeries, true);
                    } else {
                        alert('获取手术安排失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取手术安排失败');
                });
            } else {
                // Single department fetch
                fetch(`/api/surgeries?date=${dateStr}&department=${encodeURIComponent(currentDepartment)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('tableTitle').textContent = data.title;
                            displaySurgeries(data.surgeries || [], false);
                        } else {
                            alert(data.message || '获取术安排失败');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('获取手术安排失败');
                    });
            }
        }

        function displaySurgeries(surgeries, isAnesthesiaDept) {
            const tbody = document.getElementById('surgeryTableBody');
            tbody.innerHTML = '';
            
            surgeries.forEach(surgery => {
                // Format diagnosis and operation text
                const diagnosis = surgery.Diagnosis.split('(')[0].trim(); // Take only the main part
                const operation = surgery.Operation.split('+').join('、'); // Join with Chinese comma
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="width: 4%;">${surgery.BedNumber}</td>
                    <td style="width: 6%;">${surgery.PatientName}</td>
                    <td style="width: 4%;">${surgery.Gender}</td>
                    <td style="width: 4%;">${surgery.Age}</td>
                    <td style="width: 8%;">${surgery.HospitalNumber}</td>
                    <td style="width: 20%; text-align: left;">${diagnosis}</td>
                    <td style="width: 20%; text-align: left;">${operation}</td>
                    <td style="width: 6%;">${surgery.MainSurgeon}</td>
                    <td style="width: 6%;">${surgery.Assistant}</td>
                    <td style="width: 6%;">${surgery.AnesthesiaDoctor}</td>
                    <td style="width: 6%;">${surgery.AnesthesiaType}</td>
                    <td style="width: 5%;">${surgery.PreOpPrep || '无'}</td>
                    <td style="width: 5%;">${surgery.OperationOrder}</td>
                    ${isAnesthesiaDept ? `<td>${surgery.Department}</td>` : ''}
                    ${!isAnesthesiaDept ? `
                        <td class="operations-column">
                            <button class="edit-btn" onclick="editSurgery(${surgery.ID})">编辑</button>
                            <button class="delete-btn" onclick="deleteSurgery(${surgery.ID})">删除</button>
                        </td>
                    ` : ''}
                `;
                tbody.appendChild(tr);
            });
            
            // Update summary
            updateSurgerySummary(surgeries, isAnesthesiaDept);
        }

        function updateSurgerySummary(surgeries, isAnesthesiaDept) {
            const summary = {};
            const deptSummary = {};
            
            // Count surgeries for each surgeon and department
            surgeries.forEach(surgery => {
                if (!summary[surgery.MainSurgeon]) {
                    summary[surgery.MainSurgeon] = 0;
                }
                summary[surgery.MainSurgeon]++;
                
                if (isAnesthesiaDept) {
                    const dept = surgery.Department;
                    if (!deptSummary[dept]) {
                        deptSummary[dept] = 0;
                    }
                    deptSummary[dept]++;
                }
            });
            
            // Create summary text
            const tfoot = document.getElementById('surgeryTableSummary');
            const surgeonSummary = Object.entries(summary)
                .map(([surgeon, count]) => `${surgeon}医师${count}台`)
                .join('；');
            
            let summaryText = `共${surgeries.length}台；${surgeonSummary}`;
            
            if (isAnesthesiaDept) {
                const deptBreakdown = Object.entries(deptSummary)
                    .map(([dept, count]) => `${dept}${count}台`)
                    .join('，');
                summaryText = `${deptBreakdown}，${summaryText}`;
            }
            
            tfoot.innerHTML = `
                <tr>
                    <td colspan="${isAnesthesiaDept ? '15' : '14'}" style="text-align: left; padding: 10px;">
                        ${summaryText}。请在8:30a.m.接第一台。谢谢！
                    </td>
                </tr>
            `;
        }

        // Add these functions after the existing JavaScript code in surgery_schedule.html

function changeDate(direction) {
    if (direction === 'prev') {
        currentDate.setDate(currentDate.getDate() - 1);
    } else {
        currentDate.setDate(currentDate.getDate() + 1);
    }
    document.getElementById('dateSelector').value = currentDate.toISOString().split('T')[0];
    
    // Update all date displays
    document.querySelectorAll('.scheduleDate').forEach(el => {
        el.textContent = currentDate.toISOString().split('T')[0];
    });
    
    // Reload surgeries based on view mode
    if (document.getElementById('separateView').style.display === 'block') {
        loadSeparateSurgeries();
    } else {
        loadSurgeries();
    }
}

function selectDate(date) {
    currentDate = new Date(date);
    
    // Update all date displays
    document.querySelectorAll('.scheduleDate').forEach(el => {
        el.textContent = currentDate.toISOString().split('T')[0];
    });
    
    // Reload surgeries based on view mode
    if (document.getElementById('separateView').style.display === 'block') {
        loadSeparateSurgeries();
    } else {
        loadSurgeries();
    }
}

function showAddSurgery() {
    editingId = null;
    document.getElementById('modalTitle').textContent = '添加手术安排';
    document.getElementById('surgeryForm').reset();
    document.getElementById('surgeryDate').value = currentDate.toISOString().split('T')[0];
    document.getElementById('surgeryModal').style.display = 'block';
}

function closeSurgeryModal() {
    document.getElementById('surgeryModal').style.display = 'none';
    document.getElementById('surgeryForm').reset();
}

function editSurgery(id) {
    editingId = id;
    document.getElementById('modalTitle').textContent = '编辑手术安排';
    
    const dateStr = currentDate.toISOString().split('T')[0];
    fetch(`/api/surgeries?date=${dateStr}&department=${encodeURIComponent(currentDepartment)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const surgery = data.surgeries.find(s => s.ID === id);
                if (surgery) {
                    document.getElementById('surgeryDate').value = surgery.Date;
                    document.getElementById('bedNumber').value = surgery.BedNumber;
                    document.getElementById('patientName').value = surgery.PatientName;
                    document.getElementById('gender').value = surgery.Gender;
                    document.getElementById('age').value = surgery.Age;
                    document.getElementById('hospitalNumber').value = surgery.HospitalNumber;
                    document.getElementById('diagnosis').value = surgery.Diagnosis;
                    document.getElementById('operation').value = surgery.Operation;
                    document.getElementById('mainSurgeon').value = surgery.MainSurgeon;
                    document.getElementById('assistant').value = surgery.Assistant;
                    document.getElementById('wardDoctor').value = surgery.AnesthesiaDoctor;
                    document.getElementById('anesthesia').value = surgery.AnesthesiaType;
                    document.getElementById('preOpPrep').value = surgery.PreOpPrep || '无';
                    document.getElementById('operationOrder').value = surgery.OperationOrder;
                    document.getElementById('surgeryModal').style.display = 'block';
                }
            }
        });
}

function deleteSurgery(id) {
    if (confirm('确定要删除这条手术安排吗？')) {
        fetch('/api/surgery/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: id })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('手术安排已删除');
                loadSurgeries();
            } else {
                alert(data.message || '删除失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除失');
        });
    }
}

// Add form submit handler
document.getElementById('surgeryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        Department: currentDepartment,
        Date: document.getElementById('surgeryDate').value,
        BedNumber: document.getElementById('bedNumber').value,
        PatientName: document.getElementById('patientName').value,
        Gender: document.getElementById('gender').value,
        Age: document.getElementById('age').value,
        HospitalNumber: document.getElementById('hospitalNumber').value,
        Diagnosis: document.getElementById('diagnosis').value,
        Operation: document.getElementById('operation').value,
        MainSurgeon: document.getElementById('mainSurgeon').value,
        Assistant: document.getElementById('assistant').value,
        AnesthesiaDoctor: document.getElementById('wardDoctor').value,
        AnesthesiaType: document.getElementById('anesthesia').value,
        PreOpPrep: document.getElementById('preOpPrep').value,
        OperationOrder: document.getElementById('operationOrder').value,
        Creator: '系统用户'
    };

    if (editingId) {
        formData.ID = editingId;
    }

    const url = editingId ? '/api/surgery/edit' : '/api/surgery/add';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(editingId ? '手术安排已更' : '手术安排已添加');
            closeSurgeryModal();
            loadSurgeries();
        } else {
            alert(data.message || '操作失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('操作失败');
    });
});

function showHistoryModal() {
    document.getElementById('historyModal').style.display = 'block';
    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate() - 30);
    document.getElementById('historyStartDate').value = start.toISOString().split('T')[0];
    document.getElementById('historyEndDate').value = end.toISOString().split('T')[0];
}

function closeHistoryModal() {
    document.getElementById('historyModal').style.display = 'none';
}

function searchHistory() {
    const startDate = document.getElementById('historyStartDate').value;
    const endDate = document.getElementById('historyEndDate').value;
    
    if (!startDate || !endDate) {
        alert('请选择开始和结束期');
        return;
    }
    
    // For anesthesia department, fetch history from both departments
    if (currentDepartment === '手术麻醉科') {
        Promise.all([
            fetch(`/api/surgeries/history?department=${encodeURIComponent('一病区')}&start_date=${startDate}&end_date=${endDate}`).then(r => r.json()),
            fetch(`/api/surgeries/history?department=${encodeURIComponent('二病区')}&start_date=${startDate}&end_date=${endDate}`).then(r => r.json())
        ])
        .then(([data1, data2]) => {
            if (data1.success && data2.success) {
                // Combine histories from both departments
                const combinedHistory = {};
                
                // Process first department's data
                Object.entries(data1.history).forEach(([date, surgeries]) => {
                    combinedHistory[date] = surgeries.map(s => ({...s, Department: '一病区'}));
                });
                
                // Process second department's data and merge
                Object.entries(data2.history).forEach(([date, surgeries]) => {
                    if (combinedHistory[date]) {
                        combinedHistory[date] = [...combinedHistory[date], ...surgeries.map(s => ({...s, Department: '二病区'}))];
                    } else {
                        combinedHistory[date] = surgeries.map(s => ({...s, Department: '二病区'}));
                    }
                });
                
                displayHistory(combinedHistory);
            } else {
                alert('获取历史记录失败');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取历史记录失败');
        });
    } else {
        // Original single department history fetch
        fetch(`/api/surgeries/history?department=${encodeURIComponent(currentDepartment)}&start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayHistory(data.history);
                } else {
                    alert('获取历史记录失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取历史记录失败');
            });
    }
}

function displayHistory(history) {
    const container = document.getElementById('historyResults');
    container.innerHTML = '';
    
    if (Object.keys(history).length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">所选日期范围内没有手术记录</p>';
        return;
    }
    
    Object.entries(history)
        .sort((a, b) => b[0].localeCompare(a[0]))
        .forEach(([date, surgeries]) => {
            const dateDiv = document.createElement('div');
            dateDiv.innerHTML = `
                <h4 style="margin: 20px 0 10px 0;">
                    ${date} (共${surgeries.length}台手术)
                </h4>
                <table class="surgery-table">
                    <thead>
                        <tr>
                            <th>床号</th>
                            <th>姓名</th>
                            <th>手术</th>
                            <th>主刀</th>
                            <th>台次</th>
                            ${currentDepartment === '手术麻醉科' ? '<th>科室</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${surgeries.map(surgery => `
                            <tr>
                                <td>${surgery.BedNumber}</td>
                                <td>${surgery.PatientName}</td>
                                <td>${surgery.Operation}</td>
                                <td>${surgery.MainSurgeon}</td>
                                <td>${surgery.OperationOrder}</td>
                                ${currentDepartment === '手术麻醉科' ? `<td>${surgery.Department}</td>` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.appendChild(dateDiv);
        });
}

function exportData() {
    const dateStr = currentDate.toISOString().split('T')[0];
    window.location.href = `/api/surgeries/export?department=${encodeURIComponent(currentDepartment)}&start_date=${dateStr}&end_date=${dateStr}`;
}

function logout() {
    // Clear all saved data
    localStorage.clear();  // This will clear all localStorage items including 'surgery_auth' and 'selected_department'
    
    // Or if you prefer to be more specific:
    // localStorage.removeItem('surgery_auth');
    // localStorage.removeItem('selected_department');
    
    // Redirect to login page
    window.location.href = '/';
}

// Add this function to update the table header
function updateTableHeader(isAnesthesiaDept) {
    const thead = document.querySelector('.surgery-table thead tr');
    thead.innerHTML = `
        <th>床号</th>
        <th>姓名</th>
        <th>性别</th>
        <th>年龄</th>
        <th>住院号</th>
        <th>临床诊断</th>
        <th>术式</th>
        <th>主刀</th>
        <th>助手</th>
        <th>管床医师</th>
        <th>麻醉</th>
        <th>术准备</th>
        <th>台次</th>
        ${isAnesthesiaDept ? '<th>科室</th>' : ''}
        <th class="no-print">操作</th>
    `;
}

// Add this function to handle view mode selection
function selectViewMode(mode) {
    document.getElementById('viewModeSelection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    
    if (mode === 'combined') {
        // Show combined view
        document.getElementById('separateView').style.display = 'none';
        document.getElementById('combinedTable').style.display = 'block';
        updateTableHeader(true);
        loadSurgeries();
    } else {
        // Show separate view
        document.getElementById('combinedTable').style.display = 'none';
        document.getElementById('separateView').style.display = 'block';
        loadSeparateSurgeries();
    }
}

// Add function to load surgeries for separate tables
function loadSeparateSurgeries() {
    const dateStr = currentDate.toISOString().split('T')[0];
    
    // Update the titles with the date
    document.getElementById('ward1Title').textContent = `一病区手术安排表 ${dateStr}`;
    document.getElementById('ward2Title').textContent = `二病区手术安排表 ${dateStr}`;
    
    Promise.all([
        fetch(`/api/surgeries?date=${dateStr}&department=${encodeURIComponent('一病区')}`).then(r => r.json()),
        fetch(`/api/surgeries?date=${dateStr}&department=${encodeURIComponent('二病区')}`).then(r => r.json())
    ])
    .then(([data1, data2]) => {
        if (data1.success && data2.success) {
            displaySeparateSurgeries(data1.surgeries, data2.surgeries);
        } else {
            alert('获取手术安排失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('获取手术安排失败');
    });
}

// Add function to display separate tables
function displaySeparateSurgeries(ward1Surgeries, ward2Surgeries) {
    displayDepartmentSurgeries('ward1Table', '一病区', ward1Surgeries);
    displayDepartmentSurgeries('ward2Table', '二病区', ward2Surgeries);
}

function displayDepartmentSurgeries(tableId, department, surgeries) {
    const tbody = document.getElementById(`${tableId}Body`);
    tbody.innerHTML = '';
    
    surgeries.forEach(surgery => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${surgery.BedNumber}</td>
            <td>${surgery.PatientName}</td>
            <td>${surgery.Gender}</td>
            <td>${surgery.Age}</td>
            <td>${surgery.HospitalNumber}</td>
            <td>${surgery.Diagnosis}</td>
            <td>${surgery.Operation}</td>
            <td>${surgery.MainSurgeon}</td>
            <td>${surgery.Assistant}</td>
            <td>${surgery.AnesthesiaDoctor}</td>
            <td>${surgery.AnesthesiaType}</td>
            <td>${surgery.PreOpPrep || '无'}</td>
            <td>${surgery.OperationOrder}</td>
        `;
        tbody.appendChild(tr);
    });
    
    // Update summary for each department
    updateDepartmentSummary(`${tableId}Summary`, surgeries);
}

function updateDepartmentSummary(summaryId, surgeries) {
    const summary = {};
    surgeries.forEach(surgery => {
        if (!summary[surgery.MainSurgeon]) {
            summary[surgery.MainSurgeon] = 0;
        }
        summary[surgery.MainSurgeon]++;
    });
    
    const surgeonSummary = Object.entries(summary)
        .map(([surgeon, count]) => `${surgeon}医师${count}台`)
        .join('；');
    
    const summaryText = `共${surgeries.length}台；${surgeonSummary}`;
    
    document.getElementById(summaryId).innerHTML = `
        <tr>
            <td colspan="13" style="text-align: left; padding: 10px;">
                ${summaryText}。请在8:30a.m.接第一台。谢谢！
            </td>
        </tr>
    `;
}

// Add function to print specific table
function printTable(wardId) {
    const printWindow = window.open('', '_blank');
    const dateStr = currentDate.toISOString().split('T')[0];
    const department = wardId === 'ward1' ? '一病区' : '二病区';
    
    // Get the surgery data and summary
    const tableBody = document.getElementById(`${wardId}TableBody`);
    const summaryText = document.getElementById(`${wardId}TableSummary`).textContent;
    
    // Create the print content
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>${department}手术安排表</title>
            <style>
                @page {
                    size: landscape;
                    margin: 1cm;
                }
                body {
                    font-family: SimSun, serif;
                    margin: 0;
                    padding: 20px;
                }
                .print-content {
                    visibility: visible;
                }
                h1 {
                    text-align: center;
                    font-size: 18pt;
                    font-weight: bold;
                    margin-bottom: 20px;
                }
                .summary {
                    text-align: left;
                    font-size: 10pt;
                    margin: 20px 0;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                }
                th, td {
                    border: 1px solid black;
                    padding: 4px;
                    text-align: center;
                    font-size: 10pt;
                }
                th {
                    background-color: #f0f0f0;
                }
            </style>
        </head>
        <body>
            <div class="print-content">
                <h1>${department}手术安排表 ${dateStr}</h1>
                <div class="summary">${summaryText}</div>
                <table>
                    <thead>
                        <tr>
                            <th>床号</th>
                            <th>姓名</th>
                            <th>性别</th>
                            <th>年龄</th>
                            <th>住院号</th>
                            <th>临床诊断</th>
                            <th>术式</th>
                            <th>主刀</th>
                            <th>助手</th>
                            <th>管床医师</th>
                            <th>麻醉</th>
                            <th>术前准备</th>
                            <th>台次</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableBody.innerHTML}
                    </tbody>
                </table>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    
    // Wait for content to load
    setTimeout(() => {
        printWindow.focus();
        printWindow.print();
    }, 250);
}

function exportAnesthesiaData() {
    const dateStr = currentDate.toISOString().split('T')[0];
    window.location.href = `/api/surgeries/export?department=all&start_date=${dateStr}&end_date=${dateStr}`;
}

function printCombinedTable() {
    const printWindow = window.open('', '_blank');
    const dateStr = currentDate.toISOString().split('T')[0];
    
    // Get the surgery data and summary
    const tableBody = document.getElementById('surgeryTableBody');
    const summaryText = document.getElementById('surgeryTableSummary').textContent;
    
    // Create the print content
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>颌面外科手术安排表</title>
            <style>
                @page {
                    size: landscape;
                    margin: 1cm;
                }
                body {
                    font-family: SimSun, serif;
                    margin: 0;
                    padding: 20px;
                }
                .print-content {
                    visibility: visible;
                }
                h1 {
                    text-align: center;
                    font-size: 18pt;
                    font-weight: bold;
                    margin-bottom: 20px;
                }
                .summary {
                    text-align: left;
                    font-size: 10pt;
                    margin: 20px 0;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                }
                th, td {
                    border: 1px solid black;
                    padding: 4px;
                    text-align: center;
                    font-size: 10pt;
                }
                th {
                    background-color: #f0f0f0;
                }
            </style>
        </head>
        <body>
            <div class="print-content">
                <h1>颌面外科手术安排表 ${dateStr}</h1>
                <div class="summary">${summaryText}</div>
                <table>
                    <thead>
                        <tr>
                            <th>床号</th>
                            <th>姓名</th>
                            <th>性别</th>
                            <th>年龄</th>
                            <th>住院号</th>
                            <th>临床诊断</th>
                            <th>术式</th>
                            <th>主刀</th>
                            <th>助手</th>
                            <th>管床医师</th>
                            <th>麻醉</th>
                            <th>术前准备</th>
                            <th>台次</th>
                            <th>科室</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableBody.innerHTML}
                    </tbody>
                </table>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    
    // Wait for content to load
    setTimeout(() => {
        printWindow.focus();
        printWindow.print();
    }, 250);
}

function updateSurgeryTable(data) {
    if (data.success) {
        // Update the table title
        document.getElementById('tableTitle').textContent = data.title;
        
        // Rest of your table update code...
    }
}

// Add new function for department printing
function printDepartmentTable() {
    const printWindow = window.open('', '_blank');
    const dateStr = currentDate.toISOString().split('T')[0];
    
    // Get the surgery data
    const surgeries = Array.from(document.getElementById('surgeryTableBody').getElementsByTagName('tr')).map(row => {
        const cells = row.getElementsByTagName('td');
        return {
            bedNumber: cells[0].textContent,
            name: cells[1].textContent,
            gender: cells[2].textContent,
            age: cells[3].textContent,
            hospitalNumber: cells[4].textContent,
            diagnosis: cells[5].textContent,
            operation: cells[6].textContent,
            surgeon: cells[7].textContent,
            assistant: cells[8].textContent,
            doctor: cells[9].textContent,
            anesthesia: cells[10].textContent,
            prep: cells[11].textContent,
            order: cells[12].textContent
        };
    });

    // Get the summary text
    const summaryText = document.getElementById('surgeryTableSummary').textContent;
    
    // Create the print content
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <title>${currentDepartment}手术安排表</title>
            <style>
                @media print {
                    @page {
                        size: landscape;
                        margin: 1cm;
                    }
                }
                @page {
                    size: landscape;
                    margin: 1cm;
                }
                html, body {
                    width: 297mm; /* A4 landscape width */
                    height: 210mm; /* A4 landscape height */
                    margin: 0;
                    padding: 20px;
                }
                body {
                    font-family: SimSun, serif;
                }
                .title {
                    text-align: center;
                    font-size: 18pt;
                    font-weight: bold;
                    margin-bottom: 20px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    table-layout: fixed;
                }
                th, td {
                    border: 1px solid black;
                    padding: 4px;
                    text-align: center;
                    font-size: 10pt;
                }
                td {
                    height: 24px;
                }
                td:nth-child(6), td:nth-child(7) {
                    text-align: left;
                }
                .summary {
                    margin-top: 10px;
                    text-align: left;
                }
            </style>
        </head>
        <body>
            <div class="title">${currentDepartment}手术安排表 ${dateStr}</div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 4%;">床号</th>
                        <th style="width: 6%;">姓名</th>
                        <th style="width: 4%;">性别</th>
                        <th style="width: 4%;">年龄</th>
                        <th style="width: 8%;">住院号</th>
                        <th style="width: 20%;">临床诊断</th>
                        <th style="width: 20%;">术式</th>
                        <th style="width: 6%;">主刀</th>
                        <th style="width: 6%;">助手</th>
                        <th style="width: 6%;">管床医师</th>
                        <th style="width: 6%;">麻醉</th>
                        <th style="width: 5%;">术前准备</th>
                        <th style="width: 5%;">台次</th>
                    </tr>
                </thead>
                <tbody>
                    ${surgeries.map(surgery => `
                        <tr>
                            <td>${surgery.bedNumber}</td>
                            <td>${surgery.name}</td>
                            <td>${surgery.gender}</td>
                            <td>${surgery.age}</td>
                            <td>${surgery.hospitalNumber}</td>
                            <td style="text-align: left;">${surgery.diagnosis}</td>
                            <td style="text-align: left;">${surgery.operation}</td>
                            <td>${surgery.surgeon}</td>
                            <td>${surgery.assistant}</td>
                            <td>${surgery.doctor}</td>
                            <td>${surgery.anesthesia}</td>
                            <td>${surgery.prep}</td>
                            <td>${surgery.order}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="summary">${summaryText}</div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    
    // Wait for content to load
    setTimeout(() => {
        printWindow.focus();
        printWindow.print();
    }, 250);
}

async function parseHtmlFile(input) {
    if (!input.files || !input.files[0]) return;
    
    const file = input.files[0];
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/surgery/parse_html', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (data.success) {
            // Auto-fill the form fields
            document.getElementById('bedNumber').value = data.data.BedNumber;
            document.getElementById('patientName').value = data.data.PatientName;
            document.getElementById('gender').value = data.data.Gender;
            document.getElementById('age').value = data.data.Age;
            document.getElementById('hospitalNumber').value = data.data.HospitalNumber;
            document.getElementById('diagnosis').value = data.data.Diagnosis;
            document.getElementById('operation').value = data.data.Operation;
            document.getElementById('mainSurgeon').value = data.data.MainSurgeon;
            document.getElementById('wardDoctor').value = data.data.AnesthesiaDoctor;
            document.getElementById('anesthesia').value = data.data.AnesthesiaType;
        } else {
            alert('解析HTML文件失败：' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('解析HTML文件失败');
    }
    
    // Clear the file input
    input.value = '';
}
    </script>
</body>
</html> 